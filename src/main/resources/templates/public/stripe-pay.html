<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ro">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Plată cu card | Fillermed</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        .pay-page{ padding: 1.25rem 0 2rem; }
        .pay-shell{
          display:grid;
          grid-template-columns: 1fr 0.38fr;
          gap: 1rem;
          align-items:start;
        }
        .card{
          background: var(--card-bg);
          border: 1px solid #e5e7eb;
          box-shadow: 0 6px 18px rgba(15,23,42,.08);
          padding: 1rem;
        }
        .card h1{ margin:0 0 .75rem; font-size:1.35rem; font-weight:900; }
        .card h2{ margin:0 0 .75rem; font-size:1.05rem; font-weight:900; }
        .note{ margin:.75rem 0 0; color: var(--muted); font-size:.9rem; line-height:1.5; }

        .stripe-box{
          padding: .9rem;
          border: 1px solid #e5e7eb;
          background: linear-gradient(180deg, #ffffff, #f9fafb);
        }

        .btn-primary-cart{
          width:100%;
          padding:.85rem 1rem;
          border:none;
          background: var(--primary);
          color:#fff;
          font-weight:900;
          cursor:pointer;
          box-shadow: 0 12px 30px rgba(234,90,202,.25);
          text-align:center;
          display:block;
          margin-top:.8rem;
        }
        .btn-primary-cart:hover{ background: var(--primary-dark); }

        .sum{
          display:flex;
          justify-content:space-between;
          margin:.45rem 0;
          font-weight:800;
        }

        #msg{ margin-top:.7rem; color: var(--muted); font-size:.95rem; }

        @media (max-width: 900px){
          .pay-shell{ grid-template-columns: 1fr; }
        }
        @media (max-width: 640px) {
  .logo-img {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  /* ascundem doar când splash-ul e activ */
  body.has-splash .logo-img {
    opacity: 0;
    transform: translateY(-10px);
  }
}
    </style>
</head>
<body>

<div th:replace="~{public/fragments/layout :: siteHeader(${cart})}"></div>

<main class="pay-page">
    <div class="container">

        <div style="font-size:.85rem; color: var(--muted); margin: .25rem 0 1rem;">
            <a th:href="@{/}">Acasă</a> / <a th:href="@{/checkout}">Checkout</a> / <span>Plată cu card</span>
        </div>

        <div class="pay-shell">
            <section class="card">
                <h1>Plată securizată cu card</h1>

                <div class="stripe-box">
                    <div id="payment-element"></div>

                    <button id="payBtn" class="btn-primary-cart" type="button">
                        Plătește acum
                    </button>

                    <div id="msg">Introdu datele cardului pentru a finaliza plata.</div>
                </div>

                <p class="note">
                    Dacă închizi pagina înainte de confirmare, comanda va rămâne în așteptare până când plata e confirmată.
                </p>
            </section>

            <aside class="card">
                <h2>Sumar comandă</h2>

                <div class="sum">
                    <span>ID comandă</span>
                    <span th:text="${orderId}">0</span>
                </div>

                <div class="sum">
                    <span>Total</span>
                    <span><span th:text="${cart != null ? cart.totalAmount : 0}">0</span> RON</span>
                </div>

                <a class="btn-view" th:href="@{/checkout}" style="display:block; text-align:center; margin-top:.8rem;">
                    Înapoi la checkout
                </a>
            </aside>
        </div>

    </div>
</main>

<div th:replace="~{public/fragments/layout :: siteFooter}"></div>
<div th:replace="~{public/fragments/layout :: siteScripts}"></div>

<script th:inline="javascript">
    const clientSecret = [[${clientSecret}]];
    const orderId = [[${orderId}]];
    const stripePk = [[${stripePk}]];

    const stripe = Stripe(stripePk);
    const elements = stripe.elements({ clientSecret });
    const paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");

    const msg = document.getElementById("msg");
    const btn = document.getElementById("payBtn");

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      msg.textContent = "Se procesează...";

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + "/order/thank-you?orderId=" + orderId
        }
      });

      if (error) {
        msg.textContent = error.message || "Eroare la plată.";
        btn.disabled = false;
      }
    });
</script>
<script>
    // Splash (O SINGURĂ DATĂ)
    (function () {
        const splash = document.getElementById("splashScreen");
        const headerLogo = document.querySelector(".logo-img");
        if (!splash) return;

        const isMobile = window.innerWidth <= 640;

        if (!isMobile) {
            splash.classList.add("splash--hidden");
            document.body.classList.remove("has-splash");
            return;
        }

        document.body.classList.add("has-splash");

        const totalSplashTime = 3200;

        setTimeout(() => {
            splash.classList.add("splash--fade-out");

            if (headerLogo) {
                headerLogo.style.opacity = "1";
                headerLogo.style.transform = "translateY(0)";
            }

            setTimeout(() => {
                splash.classList.add("splash--hidden");
                document.body.classList.remove("has-splash");
            }, 600);
        }, totalSplashTime);
    })();

    // Carousel produse noi (O SINGURĂ DATĂ)
    (function () {
        const track = document.getElementById("newProductsTrack");
        if (!track) return;

        const cards = track.querySelectorAll(".new-product-card");
        const prevBtn = document.getElementById("prevNewProducts");
        const nextBtn = document.getElementById("nextNewProducts");
        if (!prevBtn || !nextBtn || cards.length === 0) return;

        const visibleCardsDesktop = 4;
        let index = 0;

        function getVisibleCards() {
            if (window.innerWidth <= 640) return 1;
            if (window.innerWidth <= 900) return 2;
            return visibleCardsDesktop;
        }

        function updateCarousel() {
            const visible = getVisibleCards();
            const maxIndex = Math.max(0, cards.length - visible);
            if (index > maxIndex) index = maxIndex;
            const translatePercent = (100 / visible) * index;
            track.style.transform = `translateX(-${translatePercent}%)`;
        }

        prevBtn.addEventListener("click", () => {
            const visible = getVisibleCards();
            index = Math.max(0, index - visible);
            updateCarousel();
        });

        nextBtn.addEventListener("click", () => {
            const visible = getVisibleCards();
            index = Math.min(cards.length - visible, index + visible);
            updateCarousel();
        });

        window.addEventListener("resize", updateCarousel);
        updateCarousel();
    })();

    // Burger menu (O SINGURĂ DATĂ)
    (function () {
        const burger = document.getElementById("burgerBtn");
        const headerNav = document.querySelector(".header-bottom");
        if (!burger || !headerNav) return;

        burger.addEventListener("click", () => {
            const isOpen = headerNav.classList.toggle("is-open");
            burger.classList.toggle("is-open", isOpen);
            document.body.classList.toggle("nav-open", isOpen);
        });

        window.addEventListener("resize", () => {
            if (window.innerWidth > 640 && headerNav.classList.contains("is-open")) {
                headerNav.classList.remove("is-open");
                burger.classList.remove("is-open");
                document.body.classList.remove("nav-open");
            }
        });
    })();
</script>

</body>
</html>
