<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="RO">
<head>
    <title>Comenzi - Fillermed</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
<div class="admin-layout">
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>
    <div th:replace="admin/fragments :: sidebar('orders')"></div>

    <div class="admin-main">
        <div th:replace="admin/fragments :: topbar('admin')"></div>

        <div class="content-shell">
            <div class="container-fluid py-2">

                <div th:if="${param.shipped}" class="alert alert-success">Comanda a fost marcată ca expediată.</div>
                <div th:if="${param.canceled}" class="alert alert-warning">Comanda a fost anulată.</div>

                <div class="card mb-3">
                    <div class="card-body">
                        <div class="section-title">Comenzi de trimis</div>
                        <div class="small-hint">Aici apar comenzile cu status <b>PLACED</b> (gata de procesare/expediere).</div>

                        <div th:if="${orders == null || #lists.isEmpty(orders)}" class="text-muted mt-3">
                            Nicio comandă de procesat momentan.
                        </div>

                        <div th:if="${orders != null && !#lists.isEmpty(orders)}" class="table-responsive mt-3">
                            <table class="table align-middle">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Client</th>
                                    <th>Contact</th>
                                    <th>Total</th>
                                    <th>Plată</th>
                                    <th>Creată</th>
                                    <th class="text-end">Acțiuni</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="o : ${orders}">
                                    <td><strong th:text="${o.id}">0</strong></td>
                                    <td>
                                        <div th:text="${o.customerName}">-</div>
                                        <div class="text-muted small" th:text="${o.customerEmail}">-</div>
                                    </td>
                                    <td th:text="${o.customerPhone}">-</td>
                                    <td><span th:text="${o.totalAmountRon}">0</span> RON</td>
                                    <td>
                                        <span class="badge bg-secondary" th:text="${o.paymentMethod}">COD</span>
                                        <span class="badge bg-info text-dark" th:text="${o.paymentStatus}">PAID</span>
                                    </td>
                                    <td th:text="${#temporals.format(o.createdAt, 'yyyy-MM-dd HH:mm')}">-</td>
                                    <td class="text-end">
                                        <form th:action="@{'/admin/orders/' + ${o.id} + '/ship'}" method="post" style="display:inline;">
                                            <button class="btn btn-sm btn-outline-primary" type="submit">Marchează expediată</button>
                                        </form>
                                        <form th:action="@{'/admin/orders/' + ${o.id} + '/cancel'}" method="post" style="display:inline;">
                                            <button class="btn btn-sm btn-outline-danger" type="submit">Anulează</button>
                                        </form>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    function toggleSidebar() {
      document.body.classList.toggle('sidebar-open');
    }
</script>

<!-- Polling badge (fără refresh) -->
<script>
    (function(){
      async function refresh(){
        try{
          const res = await fetch("/admin/orders/to-fulfill-count", { headers: { "Accept":"application/json" }});
          if(!res.ok) return;
          const data = await res.json();
          const count = Number(data.count || 0);

          const link = document.querySelector('a[href="/admin/orders"]');
          if(!link) return;

          let badge = link.querySelector(".sidebar-badge");

          if(count > 0){
            if(!badge){
              badge = document.createElement("span");
              badge.className = "sidebar-badge";
              link.appendChild(badge);
            }
            badge.textContent = String(count);
            badge.style.display = "";
          } else {
            if(badge) badge.style.display = "none";
          }
        } catch(e){}
      }
      refresh();
      setInterval(refresh, 15000);
    })();
</script>
</body>
</html>
